<!DOCTYPE html>
<html lang="id" data-theme="">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>ZIP Archive Backup Bot</title>

<script src="https://cdn.tailwindcss.com"></script>

<style>
    body{font-family:'Inter',sans-serif;background:#f8f9fb;color:#111;min-height:100vh;transition:.3s;}
    [data-theme="dark"] body{background:#111;color:#fff;}

    .container{
        max-width:530px;margin:auto;margin-top:30px;background:#fff;border-radius:20px;padding:25px;
        box-shadow:0 4px 14px rgba(0,0,0,.08);transition:.3s;
    }
    [data-theme="dark"] .container{background:#222;box-shadow:0 0 30px rgba(49,75,255,.15);}

    .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:9px 0;border-radius:10px;font-weight:600;transition:.2s;}
    .btn-primary{background:#4f46e5;color:#fff;}
    .btn-primary:hover{background:#4338ca;}
    .btn-secondary{background:#e5e7eb;color:#111;}
    .btn-secondary:hover{background:#d1d5db;}
    [data-theme="dark"] .btn-secondary{background:#3a3a3a;color:#fff;}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;}
    .gallery-list{display:flex!important;flex-direction:column;gap:12px;}

    .item-zip{
        padding:12px;border:1px solid #d1d5db;border-radius:15px;text-align:center;transition:.25s;
    }
    .item-zip:hover{box-shadow:0 0 10px rgba(0,0,0,.12);}
    [data-theme="dark"] .item-zip{border-color:#444;background:#333;}

    .dl-btn{padding:4px 7px;font-size:11px;border-radius:6px;font-weight:600;margin-top:4px;}
    .muted { color:#6b7280; font-size:11px; }
</style>
</head>

<body>

<div class="container">

    <h1 class="text-3xl font-bold text-center mb-6">ZIP Archive Backup Bot</h1>

    <div class="border-b pb-4 mb-5">
        <h2 class="flex items-center gap-2 text-lg font-semibold mb-3">
            <svg width="20" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v16H4zM6 8h2v2H6zm0 4h2v2H6zm0 4h2v2H6zm4-8h8v2h-8zm0 4h8v2h-8zm0 4h8v2h-8z"/></svg>
            Arsip File ZIP
        </h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
            <button onclick="toggleView()" class="btn btn-secondary">Tampilan</button>
            <button onclick="toggleTheme()" class="btn btn-secondary">Mode</button>
            <button id="refreshBtn" onclick="loadGallery()" class="btn btn-primary">Refresh</button>
        </div>
    </div>

    <label class="text-sm font-medium">Filter tanggal upload:</label>
    <input type="date" id="filterDate" onchange="loadGallery()" class="w-full mt-1 mb-3 p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600"/>

    <label class="text-sm font-medium">Urutkan:</label>
    <select id="sortMode" onchange="loadGallery()" class="w-full mt-1 mb-4 p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
        <option value="newest">Terbaru ke Terlama</option>
        <option value="oldest">Terlama ke Terbaru</option>
    </select>

    <div id="gallery" class="gallery-grid">Memuat...</div>

</div>


<script>
// tema
const root=document.documentElement;
function toggleTheme(){setTheme(root.getAttribute("data-theme")==="dark"?"light":"dark");}
function setTheme(v){root.setAttribute("data-theme",v);localStorage.setItem("theme",v);}
(function(){setTheme(localStorage.getItem("theme")||"light")})();

// tampilan list/grid
function toggleView(){
    const g=document.getElementById('gallery');
    g.classList.toggle("gallery-list");
    g.classList.toggle("gallery-grid");
}

// helper: aman parse tanggal jadi ISO YYYY-MM-DD
function toIsoDateStringFromAny(value){
    if(!value) return null;
    // jika sudah ISO-like
    if(typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) {
        return value.slice(0,10);
    }
    // coba parse via Date
    const d = new Date(value);
    if(isNaN(d)) return null;
    return d.toISOString().slice(0,10);
}

// helper format tampilan tanggal ke id-ID (yyyy-mm-dd -> 26 November 2025)
function formatDateDisplay(valueTimestampOrDate){
    if(!valueTimestampOrDate) return "-";
    const d = new Date(valueTimestampOrDate);
    if(isNaN(d)) return "-";
    return d.toLocaleDateString('id-ID', { day:'2-digit', month:'long', year:'numeric' });
}

// load files
async function loadGallery(){
    let gallery=document.getElementById('gallery');
    gallery.innerHTML="Memuat...";

    try{
        let res=await fetch("/api/list"),data=await res.json();
        if(!data.ok) throw Error(data.error||"Gagal mengambil data");

        let files=data.files || [];
        const dateInput=document.getElementById('filterDate').value; // YYYY-MM-DD
        const sort=document.getElementById('sortMode').value;

        // prepare: attach isoDate (YYYY-MM-DD) derived from timestamp or date
        files = files.map(f => {
            let iso = null;
            if(f.timestamp) {
                // f.timestamp diharapkan ISO (contoh: 2025-11-11T11:16:40Z)
                iso = toIsoDateStringFromAny(f.timestamp);
            }
            if(!iso && f.date) {
                iso = toIsoDateStringFromAny(f.date);
            }
            return Object.assign({}, f, { isoDate: iso });
        });

        // filter tanggal (hanya jika ada input)
        if(dateInput) {
            files = files.filter(f => f.isoDate === dateInput);
        }

        // sorting berdasarkan timestamp (lebih akurat). fallback ke isoDate atau 0.
        files.sort((a,b)=>{
            const ta = a.timestamp ? Date.parse(a.timestamp) : (a.isoDate ? Date.parse(a.isoDate) : 0);
            const tb = b.timestamp ? Date.parse(b.timestamp) : (b.isoDate ? Date.parse(b.isoDate) : 0);
            return sort === 'newest' ? tb - ta : ta - tb;
        });

        if(!files.length) {
            gallery.innerHTML = '<p class="text-center text-gray-500">Tidak ada file ditemukan.</p>';
            return;
        }

        gallery.innerHTML="";
        files.forEach(f=>{
            // tampilkan tanggal yang rapi (gunakan timestamp jika ada, else isoDate)
            const displayDate = f.timestamp ? formatDateDisplay(f.timestamp) : (f.isoDate ? formatDateDisplay(f.isoDate) : "unknown");

            gallery.innerHTML+=`
                <div class="item-zip flex flex-col items-center">
                    
                    <img src="https://files.catbox.moe/te1u3r.png" class="w-10 h-10" loading="lazy" alt="ikon file"/>

                    <span class="text-xs font-semibold break-all mt-1">${f.name}</span>

                    <p class="muted">
                        ${f.size || "-"} â€¢ ${displayDate}
                    </p>

                    <a href="${f.url}" download class="dl-btn bg-indigo-500 text-white hover:bg-indigo-600">
                        Download
                    </a>
                </div>`;
        });

    }catch(err){
        gallery.innerHTML=`<p class="text-center text-red-500">${err.message}</p>`;
    }
}

document.addEventListener("DOMContentLoaded",loadGallery);
</script>

</body>
</html>
